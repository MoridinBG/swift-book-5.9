{"hierarchy":{"paths":[["doc:\/\/org.swift.tspl\/documentation\/The-Swift-Programming-Language"]]},"abstract":[{"text":"Structure your code to avoid conflicts when accessing memory.","type":"text"}],"metadata":{"title":"Memory Safety"},"sections":[],"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/org.swift.tspl\/documentation\/The-Swift-Programming-Language\/MemorySafety"},"schemaVersion":{"patch":0,"major":0,"minor":3},"primaryContentSections":[{"kind":"content","content":[{"inlineContent":[{"text":"By default, Swift prevents unsafe behavior from happening in your code.","type":"text"},{"type":"text","text":" "},{"type":"text","text":"For example,"},{"type":"text","text":" "},{"text":"Swift ensures that variables are initialized before they’re used,","type":"text"},{"text":" ","type":"text"},{"text":"memory isn’t accessed after it’s been deallocated,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"and array indices are checked for out-of-bounds errors."}],"type":"paragraph"},{"inlineContent":[{"text":"Swift also makes sure that multiple accesses","type":"text"},{"type":"text","text":" "},{"text":"to the same area of memory don’t conflict,","type":"text"},{"type":"text","text":" "},{"text":"by requiring code that modifies a location in memory","type":"text"},{"text":" ","type":"text"},{"text":"to have exclusive access to that memory.","type":"text"},{"type":"text","text":" "},{"text":"Because Swift manages memory automatically,","type":"text"},{"type":"text","text":" "},{"text":"most of the time you don’t have to think about accessing memory at all.","type":"text"},{"type":"text","text":" "},{"type":"text","text":"However,"},{"text":" ","type":"text"},{"type":"text","text":"it’s important to understand where potential conflicts can occur,"},{"type":"text","text":" "},{"type":"text","text":"so you can avoid writing code that has conflicting access to memory."},{"type":"text","text":" "},{"type":"text","text":"If your code does contain conflicts,"},{"type":"text","text":" "},{"type":"text","text":"you’ll get a compile-time or runtime error."}],"type":"paragraph"},{"type":"heading","anchor":"Understanding-Conflicting-Access-to-Memory","level":2,"text":"Understanding Conflicting Access to Memory"},{"inlineContent":[{"type":"text","text":"Access to memory happens in your code"},{"type":"text","text":" "},{"text":"when you do things like set the value of a variable","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"or pass an argument to a function."},{"text":" ","type":"text"},{"type":"text","text":"For example,"},{"text":" ","type":"text"},{"type":"text","text":"the following code contains both a read access and a write access:"}],"type":"paragraph"},{"code":["\/\/ A write access to the memory where one is stored.","var one = 1","","\/\/ A read access from the memory where one is stored.","print(\"We're number \\(one)!\")"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"A conflicting access to memory can occur"},{"type":"text","text":" "},{"text":"when different parts of your code are trying","type":"text"},{"type":"text","text":" "},{"text":"to access the same location in memory at the same time.","type":"text"},{"type":"text","text":" "},{"type":"text","text":"Multiple accesses to a location in memory at the same time"},{"type":"text","text":" "},{"text":"can produce unpredictable or inconsistent behavior.","type":"text"},{"type":"text","text":" "},{"text":"In Swift, there are ways to modify a value","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"that span several lines of code,"},{"type":"text","text":" "},{"text":"making it possible to attempt to access a value","type":"text"},{"type":"text","text":" "},{"text":"in the middle of its own modification.","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"You can see a similar problem"},{"text":" ","type":"text"},{"text":"by thinking about how you update a budget","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"that’s written on a piece of paper."},{"type":"text","text":" "},{"type":"text","text":"Updating the budget is a two-step process:"},{"type":"text","text":" "},{"text":"First you add the items’ names and prices,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"and then you change the total amount"},{"type":"text","text":" "},{"type":"text","text":"to reflect the items currently on the list."},{"type":"text","text":" "},{"type":"text","text":"Before and after the update,"},{"type":"text","text":" "},{"text":"you can read any information from the budget","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"and get a correct answer,"},{"type":"text","text":" "},{"text":"as shown in the figure below.","type":"text"}]},{"inlineContent":[{"type":"image","identifier":"memory_shopping"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"While you’re adding items to the budget,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"it’s in a temporary, invalid state"},{"text":" ","type":"text"},{"type":"text","text":"because the total amount hasn’t been updated"},{"type":"text","text":" "},{"type":"text","text":"to reflect the newly added items."},{"type":"text","text":" "},{"text":"Reading the total amount","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"during the process of adding an item"},{"text":" ","type":"text"},{"type":"text","text":"gives you incorrect information."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"This example also demonstrates"},{"type":"text","text":" "},{"type":"text","text":"a challenge you may encounter"},{"type":"text","text":" "},{"type":"text","text":"when fixing conflicting access to memory:"},{"type":"text","text":" "},{"text":"There are sometimes multiple ways to fix the conflict","type":"text"},{"type":"text","text":" "},{"type":"text","text":"that produce different answers,"},{"text":" ","type":"text"},{"type":"text","text":"and it’s not always obvious which answer is correct."},{"text":" ","type":"text"},{"text":"In this example,","type":"text"},{"type":"text","text":" "},{"text":"depending on whether you wanted the original total amount","type":"text"},{"type":"text","text":" "},{"type":"text","text":"or the updated total amount,"},{"type":"text","text":" "},{"type":"text","text":"either $5 or $320 could be the correct answer."},{"text":" ","type":"text"},{"type":"text","text":"Before you can fix the conflicting access,"},{"type":"text","text":" "},{"text":"you have to determine what it was intended to do.","type":"text"}]},{"style":"note","type":"aside","name":"Note","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"If you’ve written concurrent or multithreaded code,"},{"text":" ","type":"text"},{"text":"conflicting access to memory might be a familiar problem.","type":"text"},{"type":"text","text":" "},{"text":"However,","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"the conflicting access discussed here can happen"},{"type":"text","text":" "},{"type":"text","text":"on a single thread and"},{"text":" ","type":"text"},{"type":"emphasis","inlineContent":[{"text":"doesn’t","type":"text"}]},{"type":"text","text":" involve concurrent or multithreaded code."}]},{"inlineContent":[{"type":"text","text":"If you have conflicting access to memory"},{"text":" ","type":"text"},{"text":"from within a single thread,","type":"text"},{"type":"text","text":" "},{"text":"Swift guarantees that you’ll get an error","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"at either compile time or runtime."},{"text":" ","type":"text"},{"text":"For multithreaded code,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"use "},{"isActive":true,"type":"reference","identifier":"https:\/\/developer.apple.com\/documentation\/xcode\/diagnosing_memory_thread_and_crash_issues_early"},{"text":" ","type":"text"},{"text":"to help detect conflicting access across threads.","type":"text"}],"type":"paragraph"}]},{"text":"Characteristics of Memory Access","level":3,"type":"heading","anchor":"Characteristics-of-Memory-Access"},{"inlineContent":[{"text":"There are three characteristics of memory access","type":"text"},{"type":"text","text":" "},{"type":"text","text":"to consider in the context of conflicting access:"},{"type":"text","text":" "},{"text":"whether the access is a read or a write,","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"the duration of the access,"},{"type":"text","text":" "},{"type":"text","text":"and the location in memory being accessed."},{"type":"text","text":" "},{"text":"Specifically,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"a conflict occurs if you have two accesses"},{"text":" ","type":"text"},{"type":"text","text":"that meet all of the following conditions:"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"At least one is a write access or a nonatomic access."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"They access the same location in memory."}]}]},{"content":[{"inlineContent":[{"text":"Their durations overlap.","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"inlineContent":[{"type":"text","text":"The difference between a read and write access"},{"text":" ","type":"text"},{"text":"is usually obvious:","type":"text"},{"type":"text","text":" "},{"text":"a write access changes the location in memory,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"but a read access doesn’t."},{"text":" ","type":"text"},{"text":"The location in memory","type":"text"},{"type":"text","text":" "},{"type":"text","text":"refers to what is being accessed —"},{"type":"text","text":" "},{"type":"text","text":"for example, a variable, constant, or property."},{"text":" ","type":"text"},{"type":"text","text":"The duration of a memory access"},{"type":"text","text":" "},{"type":"text","text":"is either instantaneous or long-term."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"An operation is ","type":"text"},{"type":"emphasis","inlineContent":[{"text":"atomic","type":"text"}]},{"type":"text","text":" "},{"type":"text","text":"if it uses only C atomic operations;"},{"type":"text","text":" "},{"type":"text","text":"otherwise it’s nonatomic."},{"type":"text","text":" "},{"text":"For a list of those functions, see the ","type":"text"},{"type":"codeVoice","code":"stdatomic(3)"},{"type":"text","text":" man page."}]},{"type":"paragraph","inlineContent":[{"text":"An access is ","type":"text"},{"type":"emphasis","inlineContent":[{"text":"instantaneous","type":"text"}]},{"type":"text","text":" "},{"type":"text","text":"if it’s not possible for other code to run"},{"type":"text","text":" "},{"type":"text","text":"after that access starts but before it ends."},{"type":"text","text":" "},{"type":"text","text":"By their nature, two instantaneous accesses can’t happen at the same time."},{"type":"text","text":" "},{"type":"text","text":"Most memory access is instantaneous."},{"type":"text","text":" "},{"type":"text","text":"For example,"},{"type":"text","text":" "},{"text":"all the read and write accesses in the code listing below are instantaneous:","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["func oneMore(than number: Int) -> Int {","    return number + 1","}","","var myNumber = 1","myNumber = oneMore(than: myNumber)","print(myNumber)","\/\/ Prints \"2\""]},{"type":"paragraph","inlineContent":[{"text":"However,","type":"text"},{"type":"text","text":" "},{"text":"there are several ways to access memory,","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"called "},{"inlineContent":[{"text":"long-term","type":"text"}],"type":"emphasis"},{"type":"text","text":" accesses,"},{"text":" ","type":"text"},{"type":"text","text":"that span the execution of other code."},{"type":"text","text":" "},{"type":"text","text":"The difference between instantaneous access and long-term access"},{"text":" ","type":"text"},{"type":"text","text":"is that it’s possible for other code to run"},{"text":" ","type":"text"},{"text":"after a long-term access starts but before it ends,","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"which is called "},{"inlineContent":[{"text":"overlap","type":"text"}],"type":"emphasis"},{"type":"text","text":"."},{"text":" ","type":"text"},{"type":"text","text":"A long-term access can overlap"},{"type":"text","text":" "},{"text":"with other long-term accesses and instantaneous accesses.","type":"text"}]},{"inlineContent":[{"type":"text","text":"Overlapping accesses appear primarily in code that uses"},{"type":"text","text":" "},{"type":"text","text":"in-out parameters in functions and methods"},{"text":" ","type":"text"},{"type":"text","text":"or mutating methods of a structure."},{"text":" ","type":"text"},{"type":"text","text":"The specific kinds of Swift code that use long-term accesses"},{"type":"text","text":" "},{"text":"are discussed in the sections below.","type":"text"}],"type":"paragraph"},{"text":"Conflicting Access to In-Out Parameters","type":"heading","level":2,"anchor":"Conflicting-Access-to-In-Out-Parameters"},{"inlineContent":[{"text":"A function has long-term write access","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"to all of its in-out parameters."},{"type":"text","text":" "},{"text":"The write access for an in-out parameter starts","type":"text"},{"type":"text","text":" "},{"text":"after all of the non-in-out parameters have been evaluated","type":"text"},{"type":"text","text":" "},{"type":"text","text":"and lasts for the entire duration of that function call."},{"type":"text","text":" "},{"type":"text","text":"If there are multiple in-out parameters,"},{"text":" ","type":"text"},{"text":"the write accesses start in the same order as the parameters appear.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"text":"One consequence of this long-term write access","type":"text"},{"type":"text","text":" "},{"type":"text","text":"is that you can’t access the original"},{"type":"text","text":" "},{"type":"text","text":"variable that was passed as in-out,"},{"text":" ","type":"text"},{"type":"text","text":"even if scoping rules and access control would otherwise permit it —"},{"text":" ","type":"text"},{"type":"text","text":"any access to the original creates a conflict."},{"text":" ","type":"text"},{"text":"For example:","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["var stepSize = 1","","func increment(_ number: inout Int) {","    number += stepSize","}","","increment(&stepSize)","\/\/ Error: conflicting accesses to stepSize"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"In the code above,"},{"type":"text","text":" "},{"type":"codeVoice","code":"stepSize"},{"text":" is a global variable,","type":"text"},{"type":"text","text":" "},{"text":"and it’s normally accessible from within ","type":"text"},{"code":"increment(_:)","type":"codeVoice"},{"type":"text","text":"."},{"text":" ","type":"text"},{"text":"However,","type":"text"},{"text":" ","type":"text"},{"text":"the read access to ","type":"text"},{"type":"codeVoice","code":"stepSize"},{"type":"text","text":" overlaps with"},{"type":"text","text":" "},{"text":"the write access to ","type":"text"},{"type":"codeVoice","code":"number"},{"type":"text","text":"."},{"text":" ","type":"text"},{"text":"As shown in the figure below,","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"both "},{"type":"codeVoice","code":"number"},{"text":" and ","type":"text"},{"type":"codeVoice","code":"stepSize"},{"text":" refer to the same location in memory.","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"The read and write accesses"},{"type":"text","text":" "},{"type":"text","text":"refer to the same memory and they overlap,"},{"text":" ","type":"text"},{"type":"text","text":"producing a conflict."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"memory_increment"}]},{"type":"paragraph","inlineContent":[{"text":"One way to solve this conflict","type":"text"},{"type":"text","text":" "},{"text":"is to make an explicit copy of ","type":"text"},{"code":"stepSize","type":"codeVoice"},{"type":"text","text":":"}]},{"type":"codeListing","syntax":"swift","code":["\/\/ Make an explicit copy.","var copyOfStepSize = stepSize","increment(&copyOfStepSize)","","\/\/ Update the original.","stepSize = copyOfStepSize","\/\/ stepSize is now 2"]},{"inlineContent":[{"text":"When you make a copy of ","type":"text"},{"code":"stepSize","type":"codeVoice"},{"type":"text","text":" before calling "},{"code":"increment(_:)","type":"codeVoice"},{"text":",","type":"text"},{"text":" ","type":"text"},{"text":"it’s clear that the value of ","type":"text"},{"type":"codeVoice","code":"copyOfStepSize"},{"type":"text","text":" is incremented"},{"text":" ","type":"text"},{"type":"text","text":"by the current step size."},{"type":"text","text":" "},{"text":"The read access ends before the write access starts,","type":"text"},{"type":"text","text":" "},{"text":"so there isn’t a conflict.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"Another consequence of long-term write access","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"to in-out parameters is that"},{"text":" ","type":"text"},{"text":"passing a single variable","type":"text"},{"text":" ","type":"text"},{"text":"as the argument for multiple in-out parameters","type":"text"},{"type":"text","text":" "},{"type":"text","text":"of the same function"},{"text":" ","type":"text"},{"type":"text","text":"produces a conflict."},{"type":"text","text":" "},{"text":"For example:","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["func balance(_ x: inout Int, _ y: inout Int) {","    let sum = x + y","    x = sum \/ 2","    y = sum - x","}","var playerOneScore = 42","var playerTwoScore = 30","balance(&playerOneScore, &playerTwoScore)  \/\/ OK","balance(&playerOneScore, &playerOneScore)","\/\/ Error: conflicting accesses to playerOneScore"]},{"inlineContent":[{"type":"text","text":"The "},{"type":"codeVoice","code":"balance(_:_:)"},{"text":" function above","type":"text"},{"text":" ","type":"text"},{"text":"modifies its two parameters","type":"text"},{"text":" ","type":"text"},{"text":"to divide the total value evenly between them.","type":"text"},{"type":"text","text":" "},{"text":"Calling it with ","type":"text"},{"code":"playerOneScore","type":"codeVoice"},{"type":"text","text":" and "},{"type":"codeVoice","code":"playerTwoScore"},{"type":"text","text":" as arguments"},{"type":"text","text":" "},{"text":"doesn’t produce a conflict —","type":"text"},{"text":" ","type":"text"},{"text":"there are two write accesses that overlap in time,","type":"text"},{"type":"text","text":" "},{"text":"but they access different locations in memory.","type":"text"},{"type":"text","text":" "},{"type":"text","text":"In contrast,"},{"type":"text","text":" "},{"type":"text","text":"passing "},{"type":"codeVoice","code":"playerOneScore"},{"text":" as the value for both parameters","type":"text"},{"text":" ","type":"text"},{"text":"produces a conflict","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"because it tries to perform two write accesses"},{"text":" ","type":"text"},{"text":"to the same location in memory at the same time.","type":"text"}],"type":"paragraph"},{"content":[{"type":"paragraph","inlineContent":[{"text":"Because operators are functions,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"they can also have long-term accesses to their in-out parameters."},{"text":" ","type":"text"},{"type":"text","text":"For example, if "},{"code":"balance(_:_:)","type":"codeVoice"},{"text":" was an operator function named ","type":"text"},{"type":"codeVoice","code":"<^>"},{"text":",","type":"text"},{"type":"text","text":" "},{"text":"writing ","type":"text"},{"type":"codeVoice","code":"playerOneScore <^> playerOneScore"},{"text":" ","type":"text"},{"text":"would result in the same conflict","type":"text"},{"type":"text","text":" "},{"type":"text","text":"as "},{"code":"balance(&playerOneScore, &playerOneScore)","type":"codeVoice"},{"text":".","type":"text"}]}],"name":"Note","type":"aside","style":"note"},{"type":"heading","anchor":"Conflicting-Access-to-self-in-Methods","text":"Conflicting Access to self in Methods","level":2},{"type":"paragraph","inlineContent":[{"type":"text","text":"A mutating method on a structure has write access to "},{"type":"codeVoice","code":"self"},{"text":" ","type":"text"},{"text":"for the duration of the method call.","type":"text"},{"type":"text","text":" "},{"type":"text","text":"For example, consider a game where each player"},{"text":" ","type":"text"},{"type":"text","text":"has a health amount, which decreases when taking damage,"},{"type":"text","text":" "},{"text":"and an energy amount, which decreases when using special abilities.","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["struct Player {","    var name: String","    var health: Int","    var energy: Int","","    static let maxHealth = 10","    mutating func restoreHealth() {","        health = Player.maxHealth","    }","}"]},{"type":"paragraph","inlineContent":[{"text":"In the ","type":"text"},{"type":"codeVoice","code":"restoreHealth()"},{"type":"text","text":" method above,"},{"type":"text","text":" "},{"type":"text","text":"a write access to "},{"type":"codeVoice","code":"self"},{"type":"text","text":" starts at the beginning of the method"},{"text":" ","type":"text"},{"type":"text","text":"and lasts until the method returns."},{"type":"text","text":" "},{"type":"text","text":"In this case, there’s no other code"},{"text":" ","type":"text"},{"type":"text","text":"inside "},{"type":"codeVoice","code":"restoreHealth()"},{"type":"text","text":" "},{"text":"that could have an overlapping access to the properties of a ","type":"text"},{"type":"codeVoice","code":"Player"},{"type":"text","text":" instance."},{"type":"text","text":" "},{"type":"text","text":"The "},{"type":"codeVoice","code":"shareHealth(with:)"},{"type":"text","text":" method below"},{"type":"text","text":" "},{"type":"text","text":"takes another "},{"code":"Player","type":"codeVoice"},{"type":"text","text":" instance as an in-out parameter,"},{"type":"text","text":" "},{"type":"text","text":"creating the possibility of overlapping accesses."}]},{"type":"codeListing","code":["extension Player {","    mutating func shareHealth(with teammate: inout Player) {","        balance(&teammate.health, &health)","    }","}","","var oscar = Player(name: \"Oscar\", health: 10, energy: 10)","var maria = Player(name: \"Maria\", health: 5, energy: 10)","oscar.shareHealth(with: &maria)  \/\/ OK"],"syntax":"swift"},{"type":"paragraph","inlineContent":[{"text":"In the example above,","type":"text"},{"text":" ","type":"text"},{"text":"calling the ","type":"text"},{"type":"codeVoice","code":"shareHealth(with:)"},{"text":" method","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"for Oscar’s player to share health with Maria’s player"},{"type":"text","text":" "},{"text":"doesn’t cause a conflict.","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"There’s a write access to "},{"code":"oscar","type":"codeVoice"},{"text":" during the method call","type":"text"},{"type":"text","text":" "},{"type":"text","text":"because "},{"code":"oscar","type":"codeVoice"},{"type":"text","text":" is the value of "},{"code":"self","type":"codeVoice"},{"type":"text","text":" in a mutating method,"},{"text":" ","type":"text"},{"text":"and there’s a write access to ","type":"text"},{"code":"maria","type":"codeVoice"},{"text":" ","type":"text"},{"type":"text","text":"for the same duration"},{"text":" ","type":"text"},{"type":"text","text":"because "},{"type":"codeVoice","code":"maria"},{"type":"text","text":" was passed as an in-out parameter."},{"text":" ","type":"text"},{"type":"text","text":"As shown in the figure below,"},{"type":"text","text":" "},{"text":"they access different locations in memory.","type":"text"},{"type":"text","text":" "},{"type":"text","text":"Even though the two write accesses overlap in time,"},{"type":"text","text":" "},{"text":"they don’t conflict.","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"memory_share_health_maria"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"However,"},{"text":" ","type":"text"},{"type":"text","text":"if you pass "},{"code":"oscar","type":"codeVoice"},{"type":"text","text":" as the argument to "},{"code":"shareHealth(with:)","type":"codeVoice"},{"text":",","type":"text"},{"text":" ","type":"text"},{"text":"there’s a conflict:","type":"text"}]},{"type":"codeListing","code":["oscar.shareHealth(with: &oscar)","\/\/ Error: conflicting accesses to oscar"],"syntax":"swift"},{"inlineContent":[{"type":"text","text":"The mutating method needs write access to "},{"code":"self","type":"codeVoice"},{"text":" ","type":"text"},{"type":"text","text":"for the duration of the method,"},{"type":"text","text":" "},{"type":"text","text":"and the in-out parameter needs write access to "},{"code":"teammate","type":"codeVoice"},{"type":"text","text":" "},{"type":"text","text":"for the same duration."},{"type":"text","text":" "},{"type":"text","text":"Within the method,"},{"text":" ","type":"text"},{"text":"both ","type":"text"},{"type":"codeVoice","code":"self"},{"type":"text","text":" and "},{"code":"teammate","type":"codeVoice"},{"text":" refer to","type":"text"},{"text":" ","type":"text"},{"text":"the same location in memory —","type":"text"},{"type":"text","text":" "},{"type":"text","text":"as shown in the figure below."},{"type":"text","text":" "},{"type":"text","text":"The two write accesses"},{"type":"text","text":" "},{"type":"text","text":"refer to the same memory and they overlap,"},{"text":" ","type":"text"},{"text":"producing a conflict.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"memory_share_health_oscar"}]},{"type":"heading","anchor":"Conflicting-Access-to-Properties","text":"Conflicting Access to Properties","level":2},{"type":"paragraph","inlineContent":[{"text":"Types like structures, tuples, and enumerations","type":"text"},{"text":" ","type":"text"},{"text":"are made up of individual constituent values,","type":"text"},{"text":" ","type":"text"},{"text":"such as the properties of a structure or the elements of a tuple.","type":"text"},{"text":" ","type":"text"},{"text":"Because these are value types, mutating any piece of the value","type":"text"},{"type":"text","text":" "},{"type":"text","text":"mutates the whole value,"},{"type":"text","text":" "},{"type":"text","text":"meaning read or write access to one of the properties"},{"text":" ","type":"text"},{"type":"text","text":"requires read or write access to the whole value."},{"text":" ","type":"text"},{"type":"text","text":"For example,"},{"text":" ","type":"text"},{"text":"overlapping write accesses to the elements of a tuple","type":"text"},{"type":"text","text":" "},{"text":"produces a conflict:","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["var playerInformation = (health: 10, energy: 20)","balance(&playerInformation.health, &playerInformation.energy)","\/\/ Error: conflicting access to properties of playerInformation"]},{"type":"paragraph","inlineContent":[{"text":"In the example above,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"calling "},{"type":"codeVoice","code":"balance(_:_:)"},{"text":" on the elements of a tuple","type":"text"},{"text":" ","type":"text"},{"text":"produces a conflict","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"because there are overlapping write accesses to "},{"type":"codeVoice","code":"playerInformation"},{"type":"text","text":"."},{"type":"text","text":" "},{"text":"Both ","type":"text"},{"type":"codeVoice","code":"playerInformation.health"},{"type":"text","text":" and "},{"type":"codeVoice","code":"playerInformation.energy"},{"type":"text","text":" "},{"text":"are passed as in-out parameters,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"which means "},{"code":"balance(_:_:)","type":"codeVoice"},{"text":" needs write access to them","type":"text"},{"text":" ","type":"text"},{"text":"for the duration of the function call.","type":"text"},{"text":" ","type":"text"},{"text":"In both cases, a write access to the tuple element","type":"text"},{"type":"text","text":" "},{"text":"requires a write access to the entire tuple.","type":"text"},{"text":" ","type":"text"},{"text":"This means there are two write accesses to ","type":"text"},{"type":"codeVoice","code":"playerInformation"},{"type":"text","text":" "},{"text":"with durations that overlap,","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"causing a conflict."}]},{"inlineContent":[{"type":"text","text":"The code below shows that the same error appears"},{"type":"text","text":" "},{"type":"text","text":"for overlapping write accesses"},{"type":"text","text":" "},{"type":"text","text":"to the properties of a structure"},{"type":"text","text":" "},{"text":"that’s stored in a global variable.","type":"text"}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["var holly = Player(name: \"Holly\", health: 10, energy: 10)","balance(&holly.health, &holly.energy)  \/\/ Error"]},{"inlineContent":[{"type":"text","text":"In practice,"},{"text":" ","type":"text"},{"type":"text","text":"most access to the properties of a structure"},{"text":" ","type":"text"},{"text":"can overlap safely.","type":"text"},{"type":"text","text":" "},{"type":"text","text":"For example,"},{"text":" ","type":"text"},{"text":"if the variable ","type":"text"},{"type":"codeVoice","code":"holly"},{"text":" in the example above","type":"text"},{"type":"text","text":" "},{"type":"text","text":"is changed to a local variable instead of a global variable,"},{"type":"text","text":" "},{"text":"the compiler can prove that overlapping access","type":"text"},{"text":" ","type":"text"},{"text":"to stored properties of the structure is safe:","type":"text"}],"type":"paragraph"},{"code":["func someFunction() {","    var oscar = Player(name: \"Oscar\", health: 10, energy: 10)","    balance(&oscar.health, &oscar.energy)  \/\/ OK","}"],"syntax":"swift","type":"codeListing"},{"inlineContent":[{"text":"In the example above,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"Oscar’s health and energy are passed"},{"type":"text","text":" "},{"type":"text","text":"as the two in-out parameters to "},{"type":"codeVoice","code":"balance(_:_:)"},{"text":".","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"The compiler can prove that memory safety is preserved"},{"type":"text","text":" "},{"text":"because the two stored properties don’t interact in any way.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"The restriction against"},{"text":" ","type":"text"},{"text":"overlapping access to properties of a structure","type":"text"},{"type":"text","text":" "},{"type":"text","text":"isn’t always necessary to preserve memory safety."},{"type":"text","text":" "},{"type":"text","text":"Memory safety is the desired guarantee,"},{"type":"text","text":" "},{"type":"text","text":"but exclusive access is a stricter requirement than memory safety —"},{"type":"text","text":" "},{"type":"text","text":"which means some code preserves memory safety,"},{"type":"text","text":" "},{"text":"even though it violates exclusive access to memory.","type":"text"},{"type":"text","text":" "},{"text":"Swift allows this memory-safe code if the compiler can prove","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"that the nonexclusive access to memory is still safe."},{"text":" ","type":"text"},{"type":"text","text":"Specifically, it can prove"},{"text":" ","type":"text"},{"text":"that overlapping access to properties of a structure is safe","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"if the following conditions apply:"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"You’re accessing only stored properties of an instance,"},{"type":"text","text":" "},{"type":"text","text":"not computed properties or class properties."}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"The structure is the value of a local variable,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"not a global variable."}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"The structure is either not captured by any closures,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"or it’s captured only by nonescaping closures."}],"type":"paragraph"}]}]},{"inlineContent":[{"type":"text","text":"If the compiler can’t prove the access is safe,"},{"text":" ","type":"text"},{"type":"text","text":"it doesn’t allow the access."}],"type":"paragraph"}]}],"kind":"article","references":{"doc://org.swift.tspl/documentation/The-Swift-Programming-Language":{"type":"topic","url":"\/documentation\/the-swift-programming-language","role":"collection","identifier":"doc:\/\/org.swift.tspl\/documentation\/The-Swift-Programming-Language","abstract":[],"kind":"article","title":"The Swift Programming Language (5.9)"},"memory_share_health_oscar":{"variants":[{"url":"\/images\/memory_share_health_oscar@2x.png","traits":["2x","light"]},{"traits":["2x","dark"],"url":"\/images\/memory_share_health_oscar~dark@2x.png"}],"alt":null,"identifier":"memory_share_health_oscar","type":"image"},"memory_share_health_maria":{"variants":[{"url":"\/images\/memory_share_health_maria@2x.png","traits":["2x","light"]},{"traits":["2x","dark"],"url":"\/images\/memory_share_health_maria~dark@2x.png"}],"alt":null,"type":"image","identifier":"memory_share_health_maria"},"https://developer.apple.com/documentation/xcode/diagnosing_memory_thread_and_crash_issues_early":{"title":"Thread Sanitizer","titleInlineContent":[{"text":"Thread Sanitizer","type":"text"}],"url":"https:\/\/developer.apple.com\/documentation\/xcode\/diagnosing_memory_thread_and_crash_issues_early","identifier":"https:\/\/developer.apple.com\/documentation\/xcode\/diagnosing_memory_thread_and_crash_issues_early","type":"link"},"memory_increment":{"variants":[{"traits":["2x","light"],"url":"\/images\/memory_increment@2x.png"},{"traits":["2x","dark"],"url":"\/images\/memory_increment~dark@2x.png"}],"alt":null,"type":"image","identifier":"memory_increment"},"memory_shopping":{"variants":[{"traits":["2x","light"],"url":"\/images\/memory_shopping@2x.png"},{"url":"\/images\/memory_shopping~dark@2x.png","traits":["2x","dark"]}],"alt":null,"identifier":"memory_shopping","type":"image"}}}